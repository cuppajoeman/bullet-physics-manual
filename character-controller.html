<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bullet Physics: Character Controller</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Bullet Physics
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('character-controller.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Character Controller</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>A character controller is a physics object, which is designed to be able to be moved using human or computer inputs.</p>
<h2><a class="anchor" id="current-status"></a>
Current Status</h2>
<p>When you first start researching character controllers with bullet you'll probably initially be bombarded by many people asking how to build one, additionally if you start reading into these articles you'll start piecing together an image of the state of the character controller in bullet, needless to say it's not in the best state.</p>
<ul>
<li>btKinematicCharacterController (<a href="https://github.com/bulletphysics/bullet3/issues/167#issuecomment-566853354">No longer supported</a>)</li>
</ul>
<h1><a class="anchor" id="kinematic-vs-dynamic"></a>
Kinematics vs Dynamic</h1>
<p>When it comes to character controllers there are two main types:</p>
<h2><a class="anchor" id="dynamic"></a>
Dynamic</h2>
<p>A dynamic character controller is thought of as a rigid body but unable to rotate around it's origin. This allows the body to interact with the phsics engine regularly, though these interactions may not always be predictable.</p>
<p>This type of controller doesn't have direct control over the bodies position, as it's position changes through impulses or forces. An easy way to remember this type of controller is that it's just a regular physics entity with some custom behavior.</p>
<p>There are a few things to keep in mind with this type of controller:</p><ul>
<li>It may be difficult move your character controller to a specific location as you can only interact with it through forces</li>
<li>To make it act like a "character", there will be situations where we have to hack in custom behavior to the object<ul>
<li>For example if we've modelled a stair set using a wedge, and the player attempts to climb up this wedge, since our character is just a regular physics object, they would start sliding down the wedge</li>
</ul>
</li>
</ul>
<p>The general summary of this is that to to create a dynamic character controller, you have to take a regular physics object and tweak it's behavior and disable features until it behaves as desired.</p>
<h2><a class="anchor" id="kinematic"></a>
Kinematic</h2>
<p>On the other hand a kinematic controller is one that cannot directly interact with physics objects unless it is written explicitly in the code. In order to make it actually interact with the physics world we need to define custom behavior so that if it starts intersecting a wall it is moved out of that state, or if it hits a ramp we move up the ramp instead of getting stuck.</p>
<p>This type of character controller can be good for a player that might make impossible movements such as turning corners incredibly fast and so on. To some extend character controllers are game dependent, but I believe having a solid capsule based kinematic character in bullet should be available.</p>
<h1><a class="anchor" id="btKinematicCharacterController"></a>
btKinematicCharacterController</h1>
<h2><a class="anchor" id="introduction"></a>
Introduction</h2>
<p>As we mentioned previously the kinematic controller is not in a good state, see some of the current issues:</p>
<p>relevant issues:</p><ul>
<li><a href="https://github.com/bulletphysics/bullet3/issues/4329">https://github.com/bulletphysics/bullet3/issues/4329</a></li>
<li><a href="https://github.com/bulletphysics/bullet3/discussions/3523">https://github.com/bulletphysics/bullet3/discussions/3523</a></li>
<li><a href="https://github.com/bulletphysics/bullet3/issues/84">https://github.com/bulletphysics/bullet3/issues/84</a></li>
<li><a href="https://github.com/bulletphysics/bullet3/issues/40">https://github.com/bulletphysics/bullet3/issues/40</a></li>
</ul>
<h2><a class="anchor" id="usage"></a>
Usage</h2>
<p>Even though it's not in the best state, we can still use it, here's how:</p>
<div class="fragment"><div class="line"><span class="comment">// create a kinematic character controller</span></div>
<div class="line">btPairCachingGhostObject* ghost_body = <span class="keyword">new</span> btPairCachingGhostObject();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// without this line, the ghost colision shape won&#39;t collide with anything</span></div>
<div class="line">overlapping_pair_cache-&gt;getOverlappingPairCache()-&gt;setInternalGhostPairCallback(<span class="keyword">new</span> btGhostPairCallback());</div>
<div class="line"> </div>
<div class="line"><span class="comment">// has to be an X shape due to the fact that we have to change up direction</span></div>
<div class="line">btCapsuleShape* character_body_collision_shape = <span class="keyword">new</span> btCapsuleShapeX(1.0, 3.0);</div>
<div class="line"><span class="comment">//btCapsuleShape* character_body_collision_shape = new btCapsuleShape(1.0, 3.0);</span></div>
<div class="line"> </div>
<div class="line">ghost_body-&gt;setCollisionShape(character_body_collision_shape);</div>
<div class="line">ghost_body-&gt;setCollisionFlags(btCollisionObject::CF_CHARACTER_OBJECT);</div>
<div class="line"> </div>
<div class="line">btKinematicCharacterController* kinematic_character_controller = <span class="keyword">new</span> btKinematicCharacterController(ghost_body, character_body_collision_shape, btScalar(0.1));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// The default gravity is pulling down in the x axis, therefore we fix this by pulling down in the y</span></div>
<div class="line">kinematic_character_controller-&gt;setGravity(btVector3(0, -.5, 0));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// only collide with static for now (no interaction with dynamic objects)</span></div>
<div class="line">dynamics_world-&gt;addCollisionObject(ghost_body, btBroadphaseProxy::CharacterFilter, btBroadphaseProxy::StaticFilter | btBroadphaseProxy::DefaultFilter);</div>
<div class="line">dynamics_world-&gt;addAction(kinematic_character_controller);</div>
</div><!-- fragment --><p>To control the kinematicCharacterBody, we can use <code>setWalkDirection</code>.</p>
<h2><a class="anchor" id="architecture"></a>
Architecture</h2>
<p>To understand the different components of a character controller, it's best to build it up from nothing.</p>
<p>Starting with nothing, we know that it should behave like a character, but what is a character anyway? A character is a humanoid like object that is affected by gravity, can move around, jump and bump into objects.</p>
<p>From this it motivates the attribute <code>m_walkDirection</code> representing a heading direction which represents which way the character is facing.</p>
<p>We also want our character to be affected by gravity, naively we could just change the players position by taking a gravity acceleration value and then using that to update our position using delta time. Now our character will have the ability to fall, but since our character controller doesn't have any way of detecting collisions yet, it will just fall forever.</p>
<p>In reality we want our character to fall if it's not on solid ground, so we need to be able to figure out if we're on the ground at any given moment in time. If we're not on the ground then gravity should be applied, if we are then it should not.</p>
<p>This motivates the following attributes </p><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000004">Todo</a></b></dt><dd>find which attributes are created because of this.</dd></dl>
<p>We also want our character to be able to move along a solid surface, this motivated the method <code>stepForwardAndStrafe</code>, while this allows us to move, if we run into a wall which would be a static rigid body in our simulation then we don't have any code to deal with this collision. Actually you might have already thought about this when we mentioned that our character should not move through the ground too.</p>
<p>The method motivated by this idea is called <code>recoverFromPenetration</code>, the naming convention reflects the idea that first our chracter might run into a wall and get partially stuck in the wall so that the collision shape of the character is penetrating the collision shape of wall, and now we have to recover from this situation, the standard recovery method is to just move the player back to the previous position it was at before it pentrated the wall.</p>
<p>While this penetration method can work, it can cause bouncing when you hold a key into the wall, this is caused by the character body being teleported back out of the wall and there is some space between the character and the wall. Because there is this space, the character has room to move again, this process repeating makes it seem like you are bouncing off the wall.</p>
<p>Even with no bouncing this would result in our player stopping immediately when they touch a wall, this movement would be very jarring because if you're moving quickly and you hit a wall at a shallow angle, then we would expect to keep moving around the same speed instead of just getting locked at the point we touched it.</p>
<p>In general there are two methods of dealing with situations that you don't want to occur, the first one is to allow the situation to occur and then correct before anyone notices, or to look a bit ahead into the future and make sure the situation never occurs.</p>
<p>This is generally how the move and slide function works, as it will first check based on the inputs given to the controller, if the resulting movement would make the character penetrate a static rigid body, then take the extra motion and project it onto the side of the surface so that it moves along it.</p>
<p>resources:</p><ul>
<li><a href="https://www.reddit.com/r/gamedev/comments/2og487/bullet_physics_player_controller_than_can_be/">https://www.reddit.com/r/gamedev/comments/2og487/bullet_physics_player_controller_than_can_be/</a></li>
<li><a href="https://github.com/bulletphysics/bullet3/issues/1387">https://github.com/bulletphysics/bullet3/issues/1387</a></li>
<li><a href="https://github.com/Lumak/Urho3D-KinematicCharacterController/blob/master/Source/Samples/82_KinematicPlatform/KinematicCharacterController.cpp">https://github.com/Lumak/Urho3D-KinematicCharacterController/blob/master/Source/Samples/82_KinematicPlatform/KinematicCharacterController.cpp</a></li>
<li><a href="#" onclick="location.href='mai'+'lto:'+'git'+'@g'+'ith'+'ub'+'.co'+'m'; return false;">git@g<span class="obfuscator">.nosp@m.</span>ithu<span class="obfuscator">.nosp@m.</span>b.com</a>:godotengine/godot.git (find the kinematic character controller)</li>
<li><a href="https://docs.godotengine.org/en/stable/classes/class_characterbody3d.html">https://docs.godotengine.org/en/stable/classes/class_characterbody3d.html</a></li>
<li><a href="https://stackoverflow.com/questions/25605659/avoid-ground-collision-with-bullet/25725502#25725502">https://stackoverflow.com/questions/25605659/avoid-ground-collision-with-bullet/25725502#25725502</a></li>
<li><a href="https://stackoverflow.com/questions/18345710/how-do-you-control-a-player-character-in-bullet-physics">https://stackoverflow.com/questions/18345710/how-do-you-control-a-player-character-in-bullet-physics</a></li>
<li><a href="https://pybullet.org/Bullet/phpBB3/viewtopic.php?t=11927">https://pybullet.org/Bullet/phpBB3/viewtopic.php?t=11927</a></li>
<li><a href="https://www.youtube.com/watch?v=IyEY2IIJGAU">https://www.youtube.com/watch?v=IyEY2IIJGAU</a> Urho video demonstration</li>
<li><a href="https://web.archive.org/web/20231220045058/https://gamedev.net/forums/topic/684673-btkinematiccharactercontroller-not-behaving-correctly/5324020/">https://web.archive.org/web/20231220045058/https://gamedev.net/forums/topic/684673-btkinematiccharactercontroller-not-behaving-correctly/5324020/</a></li>
<li><a href="https://gamedev.net/forums/topic/675578-bullet-various-collision-problems/5276647/">https://gamedev.net/forums/topic/675578-bullet-various-collision-problems/5276647/</a> (has source code for custom kcc controller)</li>
<li>improved stepping charcter controller <a href="https://pybullet.org/Bullet/phpBB3/viewtopic.php?f=9&t=5684">https://pybullet.org/Bullet/phpBB3/viewtopic.php?f=9&amp;t=5684</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
