<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bullet Physics: Static Map</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Bullet Physics
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('static_map.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Static Map</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="Introduction"></a>
Introduction</h1>
<p>A common task when working with a physics simulation is to have some sort of fixed map, this comes up in most simulations that have gravity so that at least your objects will not just fall forever.</p>
<p>For basic platforms feel free to use any of the built in collision shapes, but in most cases your map may be designed in a 3rd party program such as blender.</p>
<h1><a class="anchor" id="btBVHTriangleMeshShape"></a>
btBVHTriangleMeshShape</h1>
<p>When working with arbitrary geometry like this, the class you'll want to use is <code>btBvhTriangleMeshShape</code>, breaking the name of this function down we can see that we first have Bvh, which stands for "Bounding volume hierarchy", here's a quick description pulled from <a href="https://en.wikipedia.org/wiki/Bounding_volume_hierarchy">wikipedia</a>:</p>
<blockquote class="doxtable">
<p>&zwj;A bounding volume hierarchy (BVH) is a tree structure on a set of geometric objects. All geometric objects, which form the leaf nodes of the tree, are wrapped in bounding volumes </p>
</blockquote>
<p><a href="https://commons.wikimedia.org/wiki/File:Example_of_bounding_volume_hierarchy.svg" title="Schreiberx, CC BY-SA 3.0 &amp;lt;https://creativecommons.org/licenses/by-sa/3.0&amp;gt;, via Wikimedia Commons"><img src="Example_of_bounding_volume_hierarchy_dark_friendly.png" alt="Example of bounding volume hierarchy" width="512" class="inline"/></a></p>
<p>The next part of the name is <a href="https://en.wikipedia.org/wiki/Triangle_mesh">Triangle Mesh</a>.</p>
<p>At this point the name of this function should tell that you that when you use this class you'll have an internal BVH representation for acceleration purposes, it builds this acceleration structure from</p>
<h1><a class="anchor" id="loading_data"></a>
Loading in Data</h1>
<h2><a class="anchor" id="adding_triangles_manually"></a>
Loading Triangles Manually</h2>
<p>Focusing on the signature for this function, we can see that it expects a <code>btStridingMeshInterface</code>, which mentions that that is an "interface class for high performance generic access to triangle meshes", if you don't already know, an interface class is one that's not meant to be initialized. Taking a look at it's inheritance diagram you'll be able to find subclasses that actually provide an implementation for this concept.</p>
<p>The class we'll first focus our attention on is <code>btTriangleMesh</code>. The general process of using a <code>btTriangleMesh</code> is like this:</p><ol type="1">
<li>create a new <code>btTriangleMesh</code></li>
<li>create vertices of triangles add them to the mesh</li>
<li>create a <code>btCollisionShape</code> with <code>btBvhTriangleMeshShape</code> and pass in the triangle mesh we've built up in the previous steps</li>
<li>set up a rigid body with our <code>btCollisionShape</code></li>
</ol>
<p>A sample interaction could look like this:</p>
<div class="fragment"><div class="line"><span class="comment">// 1</span></div>
<div class="line">btVector3 vertex1, vertex2, vertex3, vertex4;</div>
<div class="line">btTriangleMesh* triangleMeshTerrain = <span class="keyword">new</span> btTriangleMesh();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2 create flat mesh made up of 10x10 squares</span></div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = -250; i &lt; 250; i = i + 10) {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = -250; j &lt; 250; j = j + 10) {</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// vertices of a square width side lengths of 10</span></div>
<div class="line">        vertex1 = btVector3(i, 0.0f, j);</div>
<div class="line">        vertex2 = btVector3(i + 10.0f, 0.0f, j);</div>
<div class="line">        vertex3 = btVector3(i + 10.0f, 0.0f, j + 10.0f);</div>
<div class="line">        vertex4 = btVector3(i, 0.0f, j + 10.0f);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// add the two halfs of the square</span></div>
<div class="line">        triangleMeshTerrain-&gt;addTriangle(vertex1, vertex2, vertex3);</div>
<div class="line">        triangleMeshTerrain-&gt;addTriangle(vertex1, vertex3, vertex4);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3</span></div>
<div class="line">btCollisionShape* collisionShapeTerrain = <span class="keyword">new</span> btBvhTriangleMeshShape(triangleMeshTerrain, <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 4</span></div>
<div class="line">btDefaultMotionState* motionState = <span class="keyword">new</span> btDefaultMotionState(btTransform(btQuaternion(0, 0, 0, 1), btVector3(0, -15, 0)));</div>
<div class="line"> </div>
<div class="line">btRigidBody::btRigidBodyConstructionInfo rigidBodyConstructionInfo(0.0f, motionState, collisionShapeTerrain, btVector3(0, 0, 0));</div>
<div class="line">btRigidBody* rigidBodyTerrain = <span class="keyword">new</span> btRigidBody(rigidBodyConstructionInfo);</div>
<div class="line">rigidBodyTerrain-&gt;setFriction(btScalar(0.9));</div>
<div class="line"> </div>
<div class="line">m_dynamicsWorld-&gt;addRigidBody(rigidBodyTerrain);</div>
</div><!-- fragment --><h2><a class="anchor" id="obj_files"></a>
Obj Files</h2>
<p>While programatically creating collision shapes can work, we'll need a way to load in arbitrary vertex information so that we can load in assets created by artists and files created in software such as obj files.</p>
<p>Before going any further, please become aquainted with the <a href="https://www.fileformat.info/format/wavefrontobj/egff.htm">obj format</a>.</p>
<p>For the most part we'll you'll want to load in your obj files through some obj loader program that has been already created and is external from bullet. The datastructure that you store it in will determine how you will end up loading it into bullet, but we can make a few safe assumptions.</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000006">Todo</a></b></dt><dd>figure out if bullet has an obj importer and if it does mention it here</dd></dl>
<p>We know that in general a model is a collection of meshes, and a mesh is a collection of vertices along with attributes stores on those vertices such as normals, texture coordinates and so on.</p>
<p>On top of this your obj file defines faces by passing indices that map to certain vertices, the benefit is that you don't have to repeat the same verticies again. For example if we were working on the corner of a cube, the corner vertex would have to be referenced three times, if we didn't do it this way then we'd have to list out that vertex 3 times for each triangle at that corner and doing it this way makes the obj file bigger for no reason.</p>
<p>Therefore we'll assume that your datastructure has an array of meshes, and in each mesh we create an array of indicies which is generated by iterating over each face in the mesh and then inserting each predefined (by the obj file itself) vertex index for the face into the overarching mesh index array, at the end this array should be 3 * the number of faces on the mesh. A god name for this variable could be <code>sequential_face_indices</code>, because of the way it was generated by iterating sequentially over each face and then just inserting each vertex index directly into it. Then we can create our triangle mesh as follows</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; model-&gt;meshes.size(); i++) {</div>
<div class="line"> </div>
<div class="line">    Mesh mesh = model-&gt;meshes[i];</div>
<div class="line"> </div>
<div class="line">    btTriangleMesh* triangle_mesh = <span class="keyword">new</span> btTriangleMesh();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// this only works if we know each face is a triangle</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; mesh.indices.size(); j += 3) {</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j1 = mesh.indices[j];</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j2 = mesh.indices[j + 1];</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j3 = mesh.indices[j + 2];</div>
<div class="line"> </div>
<div class="line">        btVector3 v1 = convert_vector_from_glm_to_bullet(mesh.vertices[j1].position);</div>
<div class="line">        btVector3 v2 = convert_vector_from_glm_to_bullet(mesh.vertices[j2].position);</div>
<div class="line">        btVector3 v3 = convert_vector_from_glm_to_bullet(mesh.vertices[j3].position);</div>
<div class="line"> </div>
<div class="line">        triangle_mesh-&gt;addTriangle(v1, v2, v3);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    btCollisionShape* triangle_mesh_shape = <span class="keyword">new</span> btBvhTriangleMeshShape(triangle_mesh, <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">    btDefaultMotionState* motion_state = <span class="keyword">new</span> btDefaultMotionState(btTransform(btQuaternion(0, 0, 0, 1), btVector3(0, -15, 0)));</div>
<div class="line"> </div>
<div class="line">    btRigidBody::btRigidBodyConstructionInfo rigidBodyConstructionInfo(0.0f, motion_state, triangle_mesh_shape, btVector3(0, 0, 0));</div>
<div class="line">    btRigidBody* rigidBodyTerrain = <span class="keyword">new</span> btRigidBody(rigidBodyConstructionInfo);</div>
<div class="line">    rigidBodyTerrain-&gt;setFriction(btScalar(0.9));</div>
<div class="line">     </div>
<div class="line">    this-&gt;dynamics_world-&gt;addRigidBody(rigidBodyTerrain);</div>
</div><!-- fragment --><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000007">Todo</a></b></dt><dd>the following text was my attempt to use the triangle index array method, but I never got it to work, if you can write a minimal working example of this one, that would be great.</dd></dl>
<p>From this point onward, we can reference the code for the method <code>createMeshInterface</code> in <code>Extras/Serialize/BulletWorldImporter/btWorldImporter.cpp</code>.</p>
<p>The datastructure we were working with already has <code>sequential_face_indices</code>, but it looks like this code doesn't have that defined, so during the first part of the process it defines that, in the second stage it didn't define the vertex array so it also creates that, the vertex array is simply created by moving through the vertices in the current group defined in the obj file (a group is like the same thing as a mesh but in their format, see the original link to obj file for more info) and then simply appending it into an array, note the order follows the same order as the obj file.</p>
<p>Along the way it stores the <code>sequential_face_indices</code> along with the <code>vertices</code> into an object that has the type <code>btIndexedMesh</code>, this object doesn't take in these two pieces of data upon initialization so we have to pass them in after the fact like this:</p>
<div class="fragment"><div class="line">indexed_mesh-&gt;m_triangleIndexBase = (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*) sequential_face_indices;</div>
<div class="line">indexed_mesh-&gt;m_vertexBase = (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*) verticies;</div>
</div><!-- fragment --><p>Then after storing this information into <code>indexed_mesh</code>, we can then construct a <code>btTriangleIndexVertexArray</code> by doing</p>
<div class="fragment"><div class="line">btTriangleIndexVertexArray triangle_index_vertex_array;</div>
<div class="line">triangle_index_vertex_array-&gt;addIndexedMesh(indexed_mesh);</div>
</div><!-- fragment --><p>At which point, we can then constuct a <code>btBvhTriangleMeshShape</code> from this data like this</p>
<div class="fragment"><div class="line">btCollisionShape* collisionShapeTerrain = <span class="keyword">new</span> btBvhTriangleMeshShape(triangle_index_vertex_array, <span class="keyword">true</span>);</div>
</div><!-- fragment --><p>All in all </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
